# Sticky Sessions in AWS Application Load Balancers: Ensuring Consistent User Experience

[LinkedIn - Sticky Sessions in AWS Application Load Balancers: Ensuring Consistent User Experience](https://www.linkedin.com/pulse/sticky-sessions-aws-application-load-balancers-ensuring-nauman-munir-0skzf/?trackingId=%2FUrckDAQSSGG2F%2B0geFrrA%3D%3D)

In a load-balanced environment, distributing client requests across multiple servers optimizes performance and availability. However, some applications, such as e-commerce platforms, require a user's session to remain bound to a specific server throughout their interaction. For example, in an e-commerce application, a user's shopping cart may reside on a particular server. If the load balancer redirects this user to another server during the session, the shopping cart data might be lost, disrupting the user's experience. 
To address this issue, AWS Application Load Balancers (ALBs) offer a feature known as “sticky sessions” (or “session affinity”), which ensures that a client’s session is consistently directed to the same server. This feature helps maintain a stable user experience by keeping the user's session data intact and accessible throughout their interaction with the application.
Sticky sessions work by using cookies to bind a user session to a specific server. The ALB generates a cookie that contains information about the target server. Each time the client makes a request, this cookie is included, allowing the ALB to route the request to the same server that initially handled the session. This ensures continuity, especially for applications that depend on stateful connections.
AWS Application Load Balancer supports two types of stickiness:
Duration-Based Stickiness: This method relies on the ALB to generate a cookie with a specified duration. As long as the cookie is valid, all client requests are directed to the same backend server. The session remains sticky until the cookie expires, or the client’s browser is closed. The ALB’s cookie (`AWSALB`) has a default expiration of 7 days, which is not configurable.
Application-Based Stickiness: In this mode, the stickiness is controlled by the application’s own cookies rather than the ALB-generated ones. The application manages the session duration and expiration rules. The ALB simply respects the stickiness information included in the application’s cookie and routes traffic accordingly.
Sticky sessions require the use of cookies, so the client’s browser must support cookies for this feature to work correctly. Also, there should be healthy instances in each availability zone (AZ) to handle incoming traffic effectively.
Initial Connection: The ALB routes the initial client request to one of the backend servers based on its load balancing algorithm (e.g., round-robin or least connections).
Session Creation and Cookie Assignment: After the initial server connection is established, the ALB generates a cookie (`AWSALB`) containing the target server information. This cookie is then sent to the client’s browser.
Maintaining the Session: On subsequent requests, the client’s browser includes the AWSALB cookie. The ALB reads the cookie to identify the appropriate backend server and forwards the request accordingly, maintaining session continuity.
Handling Failures: If the assigned server becomes unavailable due to a failure or deregistration, the ALB automatically selects a new server and updates the cookie to reflect this change. The updated cookie is then sent back to the client.
For WebSocket connections, sticky sessions are inherently supported and do not require explicit configuration. This is because WebSockets maintain a persistent connection between the client and server, inherently ensuring that all communication remains bound to the same server.
ALB supports cookies up to 16KB in size. However, many web browsers only support cookies up to 4KB. If the cookie exceeds this size, the ALB breaks it into smaller shards, named sequentially (e.g., AWSALBAPP-0, AWSALBAPP-1). This ensures compatibility with browser limitations and maintains session integrity.
When using Cross-Origin Resource Sharing (CORS), the ALB generates an additional cookie (`AWSALBCORS`) with the attribute SameSite=None;. This cookie is used to handle cross-origin requests and ensure that sticky sessions work seamlessly across different domains.